---
import FontSwitcher from "./FontSwitcher.astro";
import { themes, DEFAULT_THEME } from "../utils/themes";
---

<header class="top-0 right-0 fixed z-50">
  <!-- Settings Button -->
  <button
    id="toolbar-toggle-btn"
    aria-label="Toggle toolbar"
    aria-expanded="false"
    class="z-50 p-6 cursor-pointer"
  >
    <svg
      class="settings-icon w-8 h-8 text-accent"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
      ></path>
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
    </svg>
  </button>

  <!-- Toolbar Content -->
  <div
    id="toolbar-content"
    class="toolbar-content bg-base-300/80 backdrop-blur-sm rounded-lg p-6 shadow-lg border border-tertiary hidden"
  >
    <div class="flex flex-col items-start gap-2">
      <!-- Font Size Switcher -->
      <div class="flex items-center gap-1 px-1">
        <button
          id="font-size-decrease-btn"
          class="btn btn-sm btn-outline btn-square min-h-0 h-7 w-7 p-0"
          aria-label="Decrease font size"
        >
          <span class="text-sm leading-none">âˆ’</span>
        </button>
        <div class="flex items-baseline p-2" id="font-size-display">
          <span class="text-sm">A</span>
          <span class="text-base">A</span>
          <span class="text-xl">A</span>
        </div>
        <button
          id="font-size-increase-btn"
          class="btn btn-sm btn-outline btn-square min-h-0 h-7 w-7 p-0"
          aria-label="Increase font size"
        >
          <span class="text-sm leading-none">+</span>
        </button>
      </div>

      <!-- Theme Switcher -->
      <div class="flex items-center gap-2 w-full">
        <span class="text-sm">theme: </span>
        <span id="theme-display-text" class="text-sm font-medium"></span>
        <button
          id="theme-switcher-btn"
          class="btn btn-sm btn-outline btn-square ml-auto h-7 w-7"
          aria-label="Switch theme"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
          </svg>
        </button>
      </div>

      <!-- Font Switcher -->
      <FontSwitcher />

      <!-- Reset Button -->
      <button
        id="reset-settings-btn"
        class="btn btn-tertiary mt-2"
        aria-label="Reset all settings to defaults"
      >
        Reset Settings
      </button>
    </div>
  </div>
</header>

<script define:vars={{ themes, defaultTheme: DEFAULT_THEME }}>
  // Font Size Switcher
  const fontSizes = [12, 14, 16, 18, 20];
  let currentFontSizeIndex = 0;

  function findClosestFontSizeIndex(currentSize: number) {
    // Find the closest font size in the array
    let closestIndex = 0;
    let minDiff = Math.abs(fontSizes[0] - currentSize);

    for (let i = 1; i < fontSizes.length; i++) {
      const diff = Math.abs(fontSizes[i] - currentSize);
      if (diff < minDiff) {
        minDiff = diff;
        closestIndex = i;
      }
    }
    return closestIndex;
  }

  function initFontSize() {
    const savedIndex = localStorage.getItem("preferred-font-size");
    if (savedIndex !== null) {
      const index = parseInt(savedIndex, 10);
      if (index >= 0 && index < fontSizes.length) {
        currentFontSizeIndex = index;
        applyFontSize(fontSizes[currentFontSizeIndex]);
      } else {
        // If saved index is invalid, detect current size
        const currentSize = parseFloat(
          getComputedStyle(document.documentElement).fontSize
        );
        currentFontSizeIndex = findClosestFontSizeIndex(currentSize);
        applyFontSize(fontSizes[currentFontSizeIndex]);
      }
    } else {
      // Detect current root font size and match to closest
      const currentSize = parseFloat(
        getComputedStyle(document.documentElement).fontSize
      );
      currentFontSizeIndex = findClosestFontSizeIndex(currentSize);
      applyFontSize(fontSizes[currentFontSizeIndex]);
    }
  }

  function applyFontSize(size: number) {
    document.documentElement.style.fontSize = `${size}px`;
    updateFontSizeButtons();
  }

  function updateFontSizeButtons() {
    const decreaseBtn = document.getElementById(
      "font-size-decrease-btn"
    ) as HTMLButtonElement | null;
    const increaseBtn = document.getElementById(
      "font-size-increase-btn"
    ) as HTMLButtonElement | null;

    if (decreaseBtn) {
      decreaseBtn.disabled = currentFontSizeIndex === 0;
      decreaseBtn.classList.toggle("btn-disabled", currentFontSizeIndex === 0);
    }

    if (increaseBtn) {
      increaseBtn.disabled = currentFontSizeIndex === fontSizes.length - 1;
      increaseBtn.classList.toggle(
        "btn-disabled",
        currentFontSizeIndex === fontSizes.length - 1
      );
    }
  }

  function decreaseFontSize() {
    if (currentFontSizeIndex > 0) {
      currentFontSizeIndex--;
      const newSize = fontSizes[currentFontSizeIndex];
      applyFontSize(newSize);
      localStorage.setItem(
        "preferred-font-size",
        currentFontSizeIndex.toString()
      );
    }
  }

  function increaseFontSize() {
    if (currentFontSizeIndex < fontSizes.length - 1) {
      currentFontSizeIndex++;
      const newSize = fontSizes[currentFontSizeIndex];
      applyFontSize(newSize);
      localStorage.setItem(
        "preferred-font-size",
        currentFontSizeIndex.toString()
      );
    }
  }

  // Theme Switcher - All DaisyUI themes (imported from shared constants)
  let currentThemeIndex = 0;

  function getCurrentTheme() {
    // Get the current theme from the DOM (set by inline script or previous selection)
    const currentTheme = document.documentElement.getAttribute("data-theme");
    return currentTheme || defaultTheme; // Default theme if not set
  }

  function initTheme() {
    // Read the current theme from the DOM (already set by inline script)
    const currentTheme = getCurrentTheme();
    const index = themes.indexOf(currentTheme);

    if (index !== -1) {
      currentThemeIndex = index;
    } else {
      // If theme not found, check saved preference
      const savedTheme = localStorage.getItem("preferred-theme");
      if (savedTheme && themes.includes(savedTheme)) {
        currentThemeIndex = themes.indexOf(savedTheme);
        applyTheme(savedTheme);
      } else {
        // Default to default theme
        currentThemeIndex = themes.indexOf(defaultTheme);
        applyTheme(defaultTheme);
      }
    }

    // Always update button text to reflect current state
    updateThemeButton();
  }

  function applyTheme(theme: string) {
    document.documentElement.setAttribute("data-theme", theme);
    updateThemeButton();
  }

  function updateThemeButton() {
    const text = document.getElementById("theme-display-text");
    if (text) {
      text.textContent = themes[currentThemeIndex];
    }
  }

  function switchTheme() {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    const newTheme = themes[currentThemeIndex];
    applyTheme(newTheme);
    localStorage.setItem("preferred-theme", newTheme);
  }

  // Reset Settings Function
  function resetSettings() {
    // Reset font size to default (index 0)
    currentFontSizeIndex = 1;
    applyFontSize(fontSizes[1]);
    localStorage.removeItem("preferred-font-size");

    // Reset theme to default
    currentThemeIndex = themes.indexOf(defaultTheme);
    applyTheme(defaultTheme);
    localStorage.removeItem("preferred-theme");

    // Reset font to default (index 0) - trigger font reset via custom event
    localStorage.removeItem("preferred-font");
    window.dispatchEvent(new CustomEvent("reset-font"));

    // Update font size buttons
    updateFontSizeButtons();
  }

  // Toolbar Toggle Functionality
  function initToolbar() {
    const toggleBtn = document.getElementById("toolbar-toggle-btn");
    const toolbarContent = document.getElementById("toolbar-content");
    const settingsIcon = toggleBtn?.querySelector(".settings-icon");

    if (!toggleBtn || !toolbarContent) return;

    let isExpanded = false;

    function closeToolbar() {
      if (isExpanded) {
        isExpanded = false;
        toolbarContent?.classList.add("hidden");
        toggleBtn?.setAttribute("aria-expanded", "false");
        settingsIcon?.classList.remove("is-active");
      }
    }

    function toggleToolbar() {
      isExpanded = !isExpanded;

      // Toggle visibility
      if (isExpanded) {
        toolbarContent?.classList.remove("hidden");
        toggleBtn?.setAttribute("aria-expanded", "true");
        // Rotate settings icon
        settingsIcon?.classList.add("is-active");
      } else {
        toolbarContent?.classList.add("hidden");
        toggleBtn?.setAttribute("aria-expanded", "false");
        // Reset settings icon rotation
        settingsIcon?.classList.remove("is-active");
      }
    }

    toggleBtn.addEventListener("click", toggleToolbar);

    // Close toolbar when clicking outside
    document.addEventListener("click", (event) => {
      const target = event.target as Node;

      // Check if click is outside both the toolbar content and toggle button
      if (
        isExpanded &&
        !toolbarContent.contains(target) &&
        !toggleBtn.contains(target)
      ) {
        closeToolbar();
      }
    });
  }

  // Initialize font size and attach event listeners after DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    initFontSize();
    initTheme(); // Initialize theme button text after DOM is ready
    initToolbar(); // Initialize toolbar toggle

    const fontSizeDecreaseBtn = document.getElementById(
      "font-size-decrease-btn"
    );
    const fontSizeIncreaseBtn = document.getElementById(
      "font-size-increase-btn"
    );
    const themeBtn = document.getElementById("theme-switcher-btn");

    if (fontSizeDecreaseBtn) {
      fontSizeDecreaseBtn.addEventListener("click", decreaseFontSize);
    }

    if (fontSizeIncreaseBtn) {
      fontSizeIncreaseBtn.addEventListener("click", increaseFontSize);
    }

    if (themeBtn) {
      themeBtn.addEventListener("click", switchTheme);
    }

    const resetBtn = document.getElementById("reset-settings-btn");
    if (resetBtn) {
      resetBtn.addEventListener("click", resetSettings);
    }
  });
</script>

<style>
  /* Settings Icon Styling */

  .settings-icon {
    color: hsl(var(--p)); /* Primary color for stroke */
    transition: transform 0.3s ease;
    transform-origin: center;
  }

  /* Rotate settings icon when active */
  .settings-icon.is-active {
    transform: rotate(90deg);
  }

  /* Toolbar positioning - always expands below (vertical) on both mobile and desktop */
  .toolbar-content {
    position: absolute;
    top: 3.5rem;
    right: 2rem;
    margin-top: 0.5rem;
    min-width: max-content;
  }
</style>
