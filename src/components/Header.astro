---
import FontSwitcher from "./FontSwitcher.astro";
---

<header class="w-full border-b border-secondary py-2 px-4 lg:px-12">
  <div class="flex items-center justify-end gap-2">
    <!-- Font Size Switcher -->
    <div class="flex items-center gap-1 border border-secondary rounded-lg px-1">
      <button
        id="font-size-decrease-btn"
        class="btn btn-sm btn-primary btn-square min-h-0 h-7 w-7 p-0"
        aria-label="Decrease font size"
      >
        <span class="text-sm">âˆ’</span>
      </button>
      <div class="flex items-baseline gap-0.5 px-2 py-1" id="font-size-display">
        <span class="text-xs">A</span>
        <span class="text-sm">A</span>
        <span class="text-base">A</span>
      </div>
      <button
        id="font-size-increase-btn"
        class="btn btn-sm btn-primary btn-square min-h-0 h-7 w-7 p-0"
        aria-label="Increase font size"
      >
        <span class="text-sm">+</span>
      </button>
    </div>

    <!-- Theme Switcher -->
    <span class="text-sm">theme: </span>
    <button
      id="theme-switcher-btn"
      class="btn btn-sm btn-primary"
      aria-label="Switch theme"
    >
      <span id="theme-button-text" class="text-sm"></span>
    </button>

    <!-- Font Switcher -->
    <FontSwitcher />
  </div>
</header>

<script>
  // Font Size Switcher
  const fontSizes = [12, 14, 16, 18, 20];
  let currentFontSizeIndex = 0;

  function findClosestFontSizeIndex(currentSize) {
    // Find the closest font size in the array
    let closestIndex = 0;
    let minDiff = Math.abs(fontSizes[0] - currentSize);
    
    for (let i = 1; i < fontSizes.length; i++) {
      const diff = Math.abs(fontSizes[i] - currentSize);
      if (diff < minDiff) {
        minDiff = diff;
        closestIndex = i;
      }
    }
    return closestIndex;
  }

  function initFontSize() {
    const savedIndex = localStorage.getItem("preferred-font-size");
    if (savedIndex !== null) {
      const index = parseInt(savedIndex, 10);
      if (index >= 0 && index < fontSizes.length) {
        currentFontSizeIndex = index;
        applyFontSize(fontSizes[currentFontSizeIndex]);
      } else {
        // If saved index is invalid, detect current size
        const currentSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
        currentFontSizeIndex = findClosestFontSizeIndex(currentSize);
        applyFontSize(fontSizes[currentFontSizeIndex]);
      }
    } else {
      // Detect current root font size and match to closest
      const currentSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
      currentFontSizeIndex = findClosestFontSizeIndex(currentSize);
      applyFontSize(fontSizes[currentFontSizeIndex]);
    }
  }

  function applyFontSize(size) {
    document.documentElement.style.fontSize = `${size}px`;
    updateFontSizeButtons();
  }

  function updateFontSizeButtons() {
    const decreaseBtn = document.getElementById("font-size-decrease-btn");
    const increaseBtn = document.getElementById("font-size-increase-btn");
    
    if (decreaseBtn) {
      decreaseBtn.disabled = currentFontSizeIndex === 0;
      decreaseBtn.classList.toggle("btn-disabled", currentFontSizeIndex === 0);
    }
    
    if (increaseBtn) {
      increaseBtn.disabled = currentFontSizeIndex === fontSizes.length - 1;
      increaseBtn.classList.toggle("btn-disabled", currentFontSizeIndex === fontSizes.length - 1);
    }
  }

  function decreaseFontSize() {
    if (currentFontSizeIndex > 0) {
      currentFontSizeIndex--;
      const newSize = fontSizes[currentFontSizeIndex];
      applyFontSize(newSize);
      localStorage.setItem("preferred-font-size", currentFontSizeIndex.toString());
    }
  }

  function increaseFontSize() {
    if (currentFontSizeIndex < fontSizes.length - 1) {
      currentFontSizeIndex++;
      const newSize = fontSizes[currentFontSizeIndex];
      applyFontSize(newSize);
      localStorage.setItem("preferred-font-size", currentFontSizeIndex.toString());
    }
  }

  // Theme Switcher - All 35 DaisyUI themes
  const themes = [
    "light", "dark", "cupcake", "bumblebee", "emerald", "corporate",
    "synthwave", "retro", "cyberpunk", "valentine", "halloween", "garden",
    "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe",
    "black", "luxury", "dracula", "cmyk", "autumn", "business",
    "acid", "lemonade", "night", "coffee", "winter", "dim",
    "nord", "sunset", "caramellatte", "abyss", "silk"
  ];
  let currentThemeIndex = 0;

  function getCurrentTheme() {
    // Get the current theme from the DOM (set by inline script or previous selection)
    const currentTheme = document.documentElement.getAttribute("data-theme");
    return currentTheme || themes[0]; // Default to first theme if not set
  }

  function initTheme() {
    // Read the current theme from the DOM (already set by inline script)
    const currentTheme = getCurrentTheme();
    const index = themes.indexOf(currentTheme);
    
    if (index !== -1) {
      currentThemeIndex = index;
    } else {
      // If theme not found, check saved preference
      const savedTheme = localStorage.getItem("preferred-theme");
      if (savedTheme && themes.includes(savedTheme)) {
        currentThemeIndex = themes.indexOf(savedTheme);
        applyTheme(savedTheme);
      } else {
        // Fallback to system preference (default to "dark" or "light")
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const defaultTheme = prefersDark ? "dark" : "light";
        currentThemeIndex = themes.indexOf(defaultTheme);
        if (currentThemeIndex === -1) currentThemeIndex = 0;
        applyTheme(themes[currentThemeIndex]);
      }
    }
    
    // Always update button text to reflect current state
    updateThemeButton();
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    updateThemeButton();
  }

  function updateThemeButton() {
    const text = document.getElementById("theme-button-text");
    if (text) {
      text.textContent = themes[currentThemeIndex];
    }
  }

  function switchTheme() {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    const newTheme = themes[currentThemeIndex];
    applyTheme(newTheme);
    localStorage.setItem("preferred-theme", newTheme);
  }

  // Initialize font size and attach event listeners after DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    initFontSize();
    initTheme(); // Initialize theme button text after DOM is ready

    const fontSizeDecreaseBtn = document.getElementById("font-size-decrease-btn");
    const fontSizeIncreaseBtn = document.getElementById("font-size-increase-btn");
    const themeBtn = document.getElementById("theme-switcher-btn");

    if (fontSizeDecreaseBtn) {
      fontSizeDecreaseBtn.addEventListener("click", decreaseFontSize);
    }

    if (fontSizeIncreaseBtn) {
      fontSizeIncreaseBtn.addEventListener("click", increaseFontSize);
    }

    if (themeBtn) {
      themeBtn.addEventListener("click", switchTheme);
    }
  });
</script>

