---
// NASA Image of the Day Modal Component
import nasaLogo from "../assets/images/nasa-logo.png";
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import RocketShipIcon from "../assets/svgs/rocketship.astro";
---

<!-- Rocketship Button -->
<button
  id="nasa-modal-btn"
  onclick="nasa_modal.showModal()"
  aria-label="View NASA Image of the Day"
  class="z-50 px-6 py-3 cursor-pointer toolbar-item"
>
  <RocketShipIcon class="w-7 h-7 text-base hover:text-primary" />
</button>

<!-- NASA Modal -->
<dialog id="nasa_modal" class="modal">
  <div class="modal-box max-w-4xl max-h-[85vh] lg:max-h-[90vh] overflow-y-auto">
    <!-- Modal Header with NASA Logo and Title -->
    <div
      class="flex items-center justify-between gap-4 mb-6 pb-4 border-b border-base-300"
    >
      <h2 class="text-3xl font-bold text-primary">NASA Photo of the Day</h2>
      <img
        src={nasaLogo.src}
        alt="NASA Logo"
        class="w-16 h-16 object-contain"
      />
    </div>

    <div id="nasa-modal-loading" class="flex justify-center items-center py-12">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>

    <div id="nasa-modal-content" class="hidden">
      <h3 id="nasa-title" class="text-2xl font-bold mb-4"></h3>
      <div id="nasa-media-container" class="mb-4"></div>
      <p id="nasa-date" class="text-sm text-base-content/70 mb-2"></p>
      <p id="nasa-explanation" class="py-4"></p>
      <div id="nasa-copyright" class="text-sm text-base-content/60 mt-2"></div>
    </div>

    <div id="nasa-modal-error" class="hidden">
      <h3 class="text-xl font-bold text-error mb-4">
        Oops! Houston, we have a problem ðŸš€
      </h3>
      <p class="py-4" id="nasa-error-message"></p>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  import { Fancybox } from "@fancyapps/ui";

  const NASA_API_KEY = "BfdzvLycCNbh1XVti3AzfZlc8bY9lsM934UfbD68";
  const NASA_API_URL = `https://api.nasa.gov/planetary/apod?api_key=${NASA_API_KEY}`;

  let nasaDataCache: any = null;
  let hasRendered = false;
  let fancyboxInitialized = false;

  async function fetchNasaImage() {
    const loadingEl = document.getElementById("nasa-modal-loading");
    const contentEl = document.getElementById("nasa-modal-content");
    const errorEl = document.getElementById("nasa-modal-error");

    if (!loadingEl || !contentEl || !errorEl) return;

    // If we already have data cached and rendered, just show it
    if (nasaDataCache && hasRendered) {
      loadingEl.classList.add("hidden");
      contentEl.classList.remove("hidden");
      errorEl.classList.add("hidden");
      return;
    }

    // Show loading state
    loadingEl.classList.remove("hidden");
    contentEl.classList.add("hidden");
    errorEl.classList.add("hidden");

    try {
      const response = await fetch(NASA_API_URL);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      nasaDataCache = data;
      displayNasaData(data);
      hasRendered = true;
    } catch (error) {
      console.error("Error fetching NASA APOD:", error);

      loadingEl.classList.add("hidden");
      errorEl.classList.remove("hidden");

      const errorMessage = document.getElementById("nasa-error-message");
      if (errorMessage) {
        errorMessage.textContent =
          error instanceof Error
            ? `Failed to load NASA's Image of the Day: ${error.message}`
            : "Failed to load NASA's Image of the Day. Please try again later.";
      }
    }
  }

  function displayNasaData(data: any) {
    const loadingEl = document.getElementById("nasa-modal-loading");
    const contentEl = document.getElementById("nasa-modal-content");
    const titleEl = document.getElementById("nasa-title");
    const mediaContainer = document.getElementById("nasa-media-container");
    const dateEl = document.getElementById("nasa-date");
    const explanationEl = document.getElementById("nasa-explanation");
    const copyrightEl = document.getElementById("nasa-copyright");

    if (
      !loadingEl ||
      !contentEl ||
      !titleEl ||
      !mediaContainer ||
      !dateEl ||
      !explanationEl ||
      !copyrightEl
    )
      return;

    // Hide loading, show content
    loadingEl.classList.add("hidden");
    contentEl.classList.remove("hidden");

    // Populate content
    titleEl.textContent = data.title;
    dateEl.textContent = new Date(data.date).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
    explanationEl.textContent = data.explanation;

    // Handle copyright
    if (data.copyright) {
      copyrightEl.textContent = `Â© ${data.copyright}`;
      copyrightEl.classList.remove("hidden");
    } else {
      copyrightEl.classList.add("hidden");
    }

    // Handle media (image or video)
    mediaContainer.innerHTML = "";

    if (data.media_type === "video") {
      const iframe = document.createElement("iframe");
      iframe.src = data.url;
      iframe.className = "w-full aspect-video rounded-lg";
      iframe.setAttribute("allowfullscreen", "true");
      iframe.setAttribute("frameborder", "0");
      mediaContainer.appendChild(iframe);
    } else {
      // Create a link wrapper for Fancybox
      const link = document.createElement("a");
      link.href = data.hdurl || data.url;
      link.setAttribute("data-fancybox", "nasa-gallery");
      link.setAttribute("data-caption", data.title);
      link.className = "cursor-zoom-in block relative group";

      const img = document.createElement("img");
      img.src = data.hdurl || data.url;
      img.alt = data.title;
      img.className =
        "w-full rounded-lg transition-opacity group-hover:opacity-90";

      // Add zoom icon overlay
      const zoomOverlay = document.createElement("div");
      zoomOverlay.className =
        "absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/10 rounded-lg";
      zoomOverlay.innerHTML = `
        <svg class="w-12 h-12 text-white drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
        </svg>
      `;

      link.appendChild(img);
      link.appendChild(zoomOverlay);
      mediaContainer.appendChild(link);

      // Initialize Fancybox only once
      if (!fancyboxInitialized) {
        Fancybox.bind("[data-fancybox]");
        fancyboxInitialized = true;
      }
    }
  }

  // Listen for modal open events
  document.addEventListener("DOMContentLoaded", () => {
    const modalBtn = document.getElementById("nasa-modal-btn");
    const modal = document.getElementById("nasa_modal") as HTMLDialogElement;

    if (modalBtn && modal) {
      modalBtn.addEventListener("click", () => {
        fetchNasaImage();
      });
    }
  });
</script>
