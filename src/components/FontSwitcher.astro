---
// Font configuration
const fonts = [
  {
    name: "Courier Prime",
    family: "Courier Prime",
    url: "https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap",
  },
  {
    name: "Major Mono",
    family: "Major Mono Display",
    url: "https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap",
  },
  {
    name: "Turret Road",
    family: "Turret Road",
    url: "https://fonts.googleapis.com/css2?family=Turret+Road:wght@200;300;400;500;700;800&display=swap",
  },
  {
    name: "Tilt Neon",
    family: "Tilt Neon",
    url: "https://fonts.googleapis.com/css2?family=Tilt+Neon&display=swap",
  },
  {
    name: "Space Mono",
    family: "Space Mono",
    url: "https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap",
  },

  {
    name: "Syncopate",
    family: "Syncopate",
    url: "https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&display=swap",
  },
  {
    name: "Wallpoet",
    family: "Wallpoet",
    url: "https://fonts.googleapis.com/css2?family=Wallpoet&display=swap",
  },
];
---

<div class="flex items-center gap-2 w-full lg:w-auto px-6 py-3 toolbar-item">
  <span class="text-sm">font: </span>
  <span id="font-display-text" class="text-sm font-medium whitespace-nowrap"
  ></span>
  <button
    id="font-switcher-btn"
    class="btn btn-sm btn-outline btn-square h-7 w-7 relative ml-auto lg:ml-2"
    aria-label="Switch font"
  >
    <span
      class="loading loading-spinner loading-xs hidden absolute"
      aria-hidden="true"></span>
    <svg
      class="w-4 h-4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
    </svg>
  </button>
</div>

<script define:vars={{ fonts }}>
  let currentFontIndex = 0;
  const loadedFonts = new Set();
  const btn = document.getElementById("font-switcher-btn");
  const spinner = btn.querySelector(".loading-spinner");
  const fontDisplayText = document.getElementById("font-display-text");

  // Mark the initial font as loaded (it's already in the HTML)
  loadedFonts.add(fonts[0].url);

  function updateFontButton() {
    const currentFont = fonts[currentFontIndex];
    if (fontDisplayText) {
      fontDisplayText.textContent = currentFont.name;
    }
  }

  function setLoading(isLoading) {
    if (isLoading) {
      btn.disabled = true;
      btn.classList.add("btn-disabled");
      spinner.classList.remove("hidden");
      // Hide the icon when loading
      const icon = btn.querySelector("svg");
      if (icon) icon.style.display = "none";
    } else {
      btn.disabled = false;
      btn.classList.remove("btn-disabled");
      spinner.classList.add("hidden");
      // Show the icon when not loading
      const icon = btn.querySelector("svg");
      if (icon) icon.style.display = "block";
    }
  }

  function loadFont(fontUrl) {
    return new Promise((resolve, reject) => {
      // Check if font is already loaded
      if (loadedFonts.has(fontUrl)) {
        resolve();
        return;
      }

      // Create link element for font
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = fontUrl;

      link.onload = () => {
        loadedFonts.add(fontUrl);
        resolve();
      };

      link.onerror = () => {
        reject(new Error("Failed to load font"));
      };

      document.head.appendChild(link);
    });
  }

  function applyFont(fontFamily) {
    document.body.style.fontFamily = `"${fontFamily}", monospace`;
  }

  async function switchFont() {
    // Move to next font
    currentFontIndex = (currentFontIndex + 1) % fonts.length;
    const nextFont = fonts[currentFontIndex];

    setLoading(true);

    try {
      await loadFont(nextFont.url);

      // Small delay to ensure font is rendered
      await new Promise((resolve) => setTimeout(resolve, 100));

      applyFont(nextFont.family);
      updateFontButton();

      // Store preference
      localStorage.setItem("preferred-font", currentFontIndex.toString());
    } catch (error) {
      console.error("Failed to load font:", error);
    } finally {
      setLoading(false);
    }
  }

  // Initialize with saved preference
  function init() {
    const savedIndex = localStorage.getItem("preferred-font");
    if (savedIndex !== null) {
      const index = parseInt(savedIndex, 10);
      if (index >= 0 && index < fonts.length) {
        currentFontIndex = index;
        const font = fonts[currentFontIndex];
        applyFont(font.family);

        // Load the font in background if not already loaded
        if (!loadedFonts.has(font.url)) {
          loadFont(font.url).catch(console.error);
        }
      }
    } else {
      // Apply default font
      applyFont(fonts[0].family);
    }
    updateFontButton();
  }

  // Switch font on click
  btn.addEventListener("click", () => {
    switchFont();
  });

  // Listen for reset event
  window.addEventListener("reset-font", () => {
    currentFontIndex = 0;
    applyFont(fonts[0].family);
    updateFontButton();
    // Load the default font if not already loaded
    if (!loadedFonts.has(fonts[0].url)) {
      loadFont(fonts[0].url).catch(console.error);
    }
  });

  // Initialize on load
  init();
</script>
