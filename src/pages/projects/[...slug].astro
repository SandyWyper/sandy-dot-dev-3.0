---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const allProjects = await getCollection("projects");
  return allProjects.map((entry: { slug: string }) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<"projects">;
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { data } = entry;

// Get all projects to find next project
const allProjects = await getCollection("projects");
// Sort by date if available, otherwise keep original order
const sortedProjects = allProjects.sort((a, b) => {
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA; // Most recent first
});

// Find current project index
const currentIndex = sortedProjects.findIndex(
  (project) => project.slug === entry.slug
);

// Get next project (wrap to first if last)
const nextProject =
  currentIndex !== -1 && currentIndex < sortedProjects.length - 1
    ? sortedProjects[currentIndex + 1]
    : sortedProjects[0];
---

<Layout>
  <!-- Hero Section with Browser Mockup -->
  <div class="hero min-h-[70vh] bg-base-200">
    <div class="hero-content w-full max-w-7xl px-4 lg:px-8 py-12 lg:py-24">
      <div class="w-full">
        <!-- Breadcrumbs -->
        <div class="mb-6">
          <div class="breadcrumbs text-sm">
            <ul>
              <li><a href="/">Home</a></li>
              <li class="font-bold">{data.title}</li>
            </ul>
          </div>
        </div>

        <!-- Desktop: Side-by-side layout, Mobile: Stacked -->
        <div
          class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center"
        >
          <!-- Browser Mockup with Image -->
          <div class="w-full order-1 lg:order-1">
            <div
              class="mockup-browser border border-base-300 bg-base-100 shadow-lg"
            >
              <div class="mockup-browser-toolbar">
                <div class="input border border-base-300 w-full max-w-xs">
                  {
                    data.live ? (
                      <a
                        href={data.live}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-sm text-base-content/70 hover:text-primary"
                      >
                        {data.live}
                      </a>
                    ) : (
                      <span class="text-sm text-base-content/50">
                        {data.title}
                      </span>
                    )
                  }
                </div>
              </div>
              <div class="bg-base-200 p-0">
                <Image
                  src={data.cover}
                  alt={data.coverAlt ?? `${data.title} screenshot`}
                  class="w-full h-auto object-cover"
                  widths={[800, 1000, 1200, 1400, 1600]}
                  sizes="(min-width: 1024px) 50vw, 100vw"
                />
              </div>
            </div>
          </div>

          <!-- Project Info -->
          <div class="order-2 lg:order-2 flex flex-col justify-center">
            <!-- Category -->
            <p class="text-sm text-base-content/70 mb-2">
              {data.category || "Project"}
            </p>

            <!-- Title -->
            <h1 class="text-4xl lg:text-5xl font-bold mb-4">{data.title}</h1>

            <!-- Description -->
            {
              data.description && (
                <p class="text-lg lg:text-xl text-base-content/80 mb-6">
                  {data.description}
                </p>
              )
            }

            <!-- Tags -->
            {
              data.tags && data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-8">
                  {data.tags.map((tag: string) => (
                    <span class="badge badge-primary badge-lg">{tag}</span>
                  ))}
                </div>
              )
            }

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4">
              {
                data.live && (
                  <a
                    href={data.live}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn btn-primary btn-lg"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-5 h-5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"
                      />
                    </svg>
                    Live Site
                  </a>
                )
              }
              {
                data.repository && (
                  <a
                    href={data.repository}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn btn-outline btn-primary btn-lg"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-5 h-5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5"
                      />
                    </svg>
                    View Code
                  </a>
                )
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Section -->
  <article class="max-w-4xl mx-auto px-4 lg:px-8 py-12 lg:py-24">
    <div class="space-y-6 prose min-w-full">
      <Content />
    </div>
  </article>

  <!-- Next Project Section -->
  <section class="max-w-4xl mx-auto px-4 lg:px-8 pb-12 lg:pb-24">
    <div class="divider mb-8"></div>
    <div class="flex flex-col items-center text-center">
      <p class="text-sm text-base-content/70 mb-4">Next Project</p>
      <a
        href={`/projects/${nextProject.slug}`}
        class="btn btn-primary btn-lg btn-wide"
      >
        <span>{nextProject.data.title}</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M13.5 4.5 21 12m0 0-8.5 7.5M21 12H3"></path>
        </svg>
      </a>
    </div>
  </section>
</Layout>
